# BedTime

本项目基于 Taro + React 构建，提供早睡打卡与好友互助功能。

## 云数据库调用流程

- 所有与微信云开发的交互都集中在 `src/services` 模块中，并通过 `cloud.ts` 统一初始化云环境。
- `supportsCloud` 会根据运行环境与配置判断是否可以启用云能力；`ensureCloud` 负责初始化并缓存数据库实例，避免重复创建连接。
- `getCurrentOpenId` 使用登录云函数获取用户的 `openid`，并在成功后缓存，减少后续的远程调用次数。
- 业务模块（用户、打卡、公开资料）仅在需要时调用 `ensureCloud`，因此在本地模式下依旧可以正常运行。

## 用户信息的采集与使用

- `user.ts` 负责管理用户资料，包括 UID 生成、昵称、目标就寝时间、好友列表及是否开启好友互助等字段。
- 用户首次访问时，如果云端不存在记录，将自动分配一个 8 位 UID，并写入数据库；本地返回的数据会转换为标准 `Date` 对象，方便前端使用。
- 更新用户资料时会对昵称、目标时间、时区和好友列表进行格式化处理，过滤重复或空白数据，同时写入更新时间戳。
- 好友公开资料（昵称、目标就寝时间、今日状态、连胜等）通过 `profile.ts` 刷新并存储在 `publicProfiles` 集合中，供好友列表展示使用。
- 所有与用户身份相关的数据仅用于提供打卡、好友监督等核心功能，不会在未开启云能力时发起网络请求。
