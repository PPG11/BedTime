# 云函数配置说明

## 概述

BedTime 应用支持两种模式运行：
1. **云开发模式**：使用微信云开发存储用户数据和好友信息，支持多设备同步
2. **本地模式**：数据仅存储在本地，不需要配置云开发

## 云开发模式配置步骤

### 1. 开通微信云开发

1. 在微信开发者工具中打开项目
2. 点击「云开发」按钮
3. 按照提示开通云开发服务
4. 记录下你的云开发环境 ID（env-xxxxx）

### 2. 配置环境变量

在项目根目录的 `.env` 或构建配置中设置：

```bash
TARO_APP_CLOUD_ENV=你的云开发环境ID
```

或者直接修改 `src/config/cloud.ts` 文件：

```typescript
export const CLOUD_ENV_ID = '你的云开发环境ID'
```

### 3. 创建数据库集合

在微信开发者工具的「云开发控制台」→「数据库」中创建以下集合：

- `users` - 用户信息
- `checkins` - 打卡记录
- `public_profiles` - 公开的用户资料（用于好友功能）

### 4. 部署云函数

在微信开发者工具中：

1. 右键点击 `cloudfunctions/login` 文件夹
2. 选择「上传并部署：云端安装依赖」
3. 等待部署完成

### 5. 配置数据库权限

在云开发控制台的「数据库」→「集合权限」中：

- `users`: 仅创建者可读写
- `checkins`: 仅创建者可读写
- `public_profiles`: 所有人可读，仅创建者可写

## 本地模式

如果你不想使用云开发功能：

1. **不需要配置任何东西**
2. 应用会自动检测云开发是否可用
3. 如果云开发不可用，会自动使用本地存储模式
4. 本地模式下，所有数据存储在小程序的本地缓存中

## 问题排查

### 页面显示空白

如果页面只显示导航栏，内容全白：

1. 检查控制台是否有错误信息
2. 确认云函数 `login` 已正确部署
3. 如果不使用云开发，应用会自动回退到本地模式，稍等片刻即可

### 云函数调用失败

提示"云端同步失败，使用本地模式"时：

1. 检查云开发环境 ID 是否正确配置
2. 确认云函数已部署
3. 检查网络连接
4. 本地模式仍可正常使用，只是数据不会同步到云端

## 云函数说明

### login

**功能**：获取用户的 openid，用于标识用户身份

**输入**：无

**输出**：
```javascript
{
  openid: string,  // 用户唯一标识
  appid: string,   // 小程序 appid
  unionid: string  // 开放平台 unionid（如果有）
}
```

## 后续扩展

如果需要更多云开发功能，可以在 `cloudfunctions` 目录下创建新的云函数。

